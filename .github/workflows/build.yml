      - name: Build Geyser
        id: build-step
        run: |
          echo "========================================"
          echo "开始构建 Geyser - 版本: $BUILD_NUMBER"
          echo "========================================"
          
          # 1. 清理环境
          echo "1. 清理环境..."
          rm -rf ~/.gradle/caches
          ./gradlew clean
          
          # 2. 创建修复配置
          echo "2. 创建修复配置..."
          cat > settings.gradle.kts.fix << 'EOF'
          pluginManagement {
              repositories {
                  gradlePluginPortal()
                  mavenCentral()
                  maven("https://maven.fabricmc.net/")
                  maven("https://maven.neoforged.net/releases")
                  maven("https://repo.spongepowered.org/repository/maven-public/")
              }
              
              plugins {
                  id("dev.architectury.loom") version "1.11.458"
                  id("architectury-plugin") version "3.4.162"
              }
          }
          
          rootProject.name = "Geyser"
          
          include(":api")
          include(":common")
          include(":core")
          include(":bungeecord")
          include(":spigot")
          include(":standalone")
          include(":velocity")
          include(":viaproxy")
          include(":mod:fabric")
          include(":mod:neoforge")
          include(":ap")
          EOF
          
          # 3. 修复 build.gradle.kts 文件
          echo "3. 修复 build.gradle.kts 文件..."
          if [ -f "build.gradle.kts" ]; then
            cp build.gradle.kts build.gradle.kts.backup
            
            # 创建一个简化的 build.gradle.kts
            cat > build.gradle.kts << 'EOF'
          import org.gradle.kotlin.dsl.*
          
          plugins {
              id("geyser.base-conventions")
              id("architectury-plugin") version "3.4.162"
          }
          
          allprojects {
              group = "org.geysermc"
              version = "2.9.1-SNAPSHOT"
              
              repositories {
                  mavenCentral()
                  maven("https://repo.spongepowered.org/repository/maven-public/")
                  maven("https://oss.sonatype.org/content/repositories/snapshots")
                  maven("https://maven.neoforged.net/releases")
                  maven("https://maven.fabricmc.net/")
              }
          }
          
          subprojects {
              apply(plugin = "geyser.base-conventions")
          }
          EOF
          fi
          
          # 4. 构建 build-logic 模块
          echo "4. 构建 build-logic 模块..."
          cd build-logic
          ./gradlew build --no-daemon --stacktrace || echo "build-logic 构建失败"
          cd ..
          
          # 5. 使用原始配置构建
          echo "5. 恢复原始配置并构建..."
          if [ -f "build.gradle.kts.backup" ]; then
            mv build.gradle.kts.backup build.gradle.kts
          fi
          
          # 6. 分模块构建
          echo "6. 分模块构建..."
          
          # 构建核心模块
          echo "构建核心模块..."
          ./gradlew :api:compileJava :common:compileJava :core:compileJava \
            --no-daemon --stacktrace --info \
            -Dorg.gradle.jvmargs="-Xmx4g" \
            2>&1 | tail -200 || echo "核心模块编译失败"
          
          # 如果核心模块编译成功，构建其他模块
          if [ $? -eq 0 ]; then
            echo "核心模块编译成功，构建其他模块..."
            ./gradlew build -x test --no-daemon --stacktrace
          else
            echo "核心模块编译失败，尝试构建其他平台模块..."
            ./gradlew :bungeecord:build :spigot:build :standalone:build \
              :velocity:build :viaproxy:build \
              --no-daemon --stacktrace
          fi
          
          echo "========================================"
          echo "构建完成！"
          echo "========================================"
        env:
          BUILD_NUMBER: ${{ steps.release-info.outputs.curentRelease }}